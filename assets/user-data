#cloud-config

# This is the user-data configuration file for cloud-init. By default this sets
# up an initial user called "ubuntu" with password "ubuntu", which must be
# changed at first login. However, many additional actions can be initiated on
# first boot from this file. The cloud-init documentation has more details:
#
# https://cloudinit.readthedocs.io/
#
# Some additional examples are provided in comments below the default
# configuration.

# Enable password authentication with the SSH daemon
ssh_pwauth: true

# setup timezone
timezone: Europe/Brussels

# help in case of trouble
debug:
  verbose: true

# enable ntp
ntp:
  enabled: true
  ntp_client: chrony  # Uses cloud-init default chrony configuration


# Add 'worker' as default user
system_info:
  default_user:
    name: worker
groups:
  - worker
users:
  - name: worker
    gecos: Worker
    primary_group: worker
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    shell: /bin/bash
    lock_passwd: false
    plain_text_passwd: worker
    groups: [adm, audio, cdrom, dialout, dip, floppy, lxd, netdev, plugdev, sudo, video, plugdev]
    chpasswd: { expire: false }

# Update apt database and upgrade packages on first boot
package_update: true
package_upgrade: true

# Install additional packages on first boot
packages:
  # shell & command line utilities:
  - curl
  # set python as default:
  - python-is-python3
  - python-dev-is-python3
  - python3-pip
  # install lava utils
  - lavacli

runcmd:
  # copy public key
  - mkdir -p /home/worker/.ssh
  - cp /boot/firmware/id_rsa.pub /home/worker/.ssh/authorized_keys
  # make sure /home/worker owner is properly set
  - chown -R worker:worker /home/worker/
  - chmod 700 /home/worker/.ssh
  - chmod 600 /home/worker/.ssh/authorized_keys
  # install argon1.sh
  - curl https://raw.githubusercontent.com/meuter/argon-one-case-ubuntu-20.04/master/argon1.sh --output /usr/local/bin/install-argonone-case-scripts
  - chmod a+x /usr/local/bin/install-argonone-case-scripts
  # install lava-common, lava-dispatcher and lava-dispatcher-host
  - mkdir -p /opt/lava/
  - curl https://codeload.github.com/Linaro/lava/tar.gz/2020.10 --output /opt/lava/lava-dispatcher.tar.gz
  - tar xf /opt/lava/lava-dispatcher.tar.gz -C /opt/lava
  - python /opt/lava/lava-2020.10/share/requires.py --package lava-common --distribution debian --suite buster --names > /opt/lava/lava-2020.10/deps.txt
  - python /opt/lava/lava-2020.10/share/requires.py --package lava-dispatcher --distribution debian --suite buster --names >> /opt/lava/lava-2020.10/deps.txt
  - python /opt/lava/lava-2020.10/share/requires.py --package lava-dispatcher-host --distribution debian --suite buster --names >> /opt/lava/lava-2020.10/deps.txt
  - apt install -y $(cat /opt/lava/lava-2020.10/deps.txt)
  - cd /opt/lava/lava-2020.10 && python setup.py install lava-common && python setup.py install lava-dispatcher && python setup.py install lava-dispatcher-host
